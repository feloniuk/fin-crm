# Технічне завдання: Система управління замовленнями та документообігом

## 1. ЗАГАЛЬНИЙ ОПИС

**Призначення:** Веб-система для автоматизації обробки замовлень з інтернет-магазинів (Horoshop, Prom.ua) з генерацією бухгалтерських документів та контролем лімітів по ФОП/ТОВ.

**Користувачі системи:**
- Адміністратор - повний доступ до всіх функцій
- Менеджер - тільки перегляд даних (без створення/редагування)

**Технології:**
- Laravel 12 + PHP 8.2+
- Filament v4 (адмін-панель)
- MySQL 8.0+
- PhpSpreadsheet (Excel)
- DomPDF (PDF)

---

## 2. СТРУКТУРА ДАНИХ

### 2.1 Магазини (Shops)
**Призначення:** Збереження налаштувань підключених інтернет-магазинів

**Поля:**
- Назва магазину (Хорошоп №1, Пром.ua магазин)
- Тип (Horoshop або Prom.ua)
- API credentials (ключі доступу, токени, webhook секрети)
- Статус активності

### 2.2 Замовлення (Orders)
**Призначення:** Збереження синхронізованих замовлень з магазинів

**Поля:**
- ID замовлення в зовнішній системі
- Магазин (звідки замовлення)
- ПІБ покупця
- Телефон покупця
- Коментар покупця
- Загальна сума замовлення
- Статус (нове, в обробці, виставлено рахунок, оплачено)
- Повні дані з API (JSON)
- Дата синхронізації

### 2.3 Наші компанії (Our Companies) - ФОП/ТОВ
**Призначення:** Реєстр юридичних осіб від імені яких виставляються рахунки

**Поля:**
- Назва (ФОП Іванов І.І., ТОВ "Компанія")
- Тип (ФОП або ТОВ)
- Система оподаткування (єдиний податок або ПДВ)
- ЄДРПОУ/ІПН
- Адреса, телефон, email
- Банківські реквізити (банк, МФО, рахунок, IBAN)
- Підписант (ПІБ, посада)
- Річний ліміт обороту (тільки для єдиного податку)
- Статус активності

**Правила:**
- Для ФОП на єдиному податку обов'язковий річний ліміт
- Для ТОВ на ПДВ ліміту немає

### 2.4 Контрагенти-покупці (Counterparties)
**Призначення:** Реєстр покупців з реквізитами

**Поля:**
- Назва/ПІБ
- ЄДРПОУ/ІПН
- Адреса
- Телефон
- Email
- Ознака автостворення (створено автоматично з замовлення)

### 2.5 Рахунки (Invoices)
**Призначення:** Виставлені рахунки для замовлень

**Поля:**
- Номер рахунку (автогенерований)
- Дата рахунку
- Замовлення (посилання)
- Наша компанія (ФОП/ТОВ від імені якої виставлено)
- Контрагент-покупець
- З ПДВ чи без ПДВ
- Коментар (наприклад: "Рахунок до договору №5 від 01.01.2025")
- Тип знижки (відсотки, фіксована сума, без знижки)
- Значення знижки
- Сума без ПДВ
- Сума ПДВ
- Загальна сума
- Ознака оплати
- Дата оплати
- Шлях до Excel файлу
- Шлях до PDF файлу

### 2.6 Позиції рахунку (Invoice Items)
**Призначення:** Товари в рахунку

**Поля:**
- Рахунок (посилання)
- Назва товару
- Кількість
- Ціна за одиницю
- Знижка на позицію
- Підсумок (кількість × ціна - знижка)

---

## 3. БІЗНЕС-ПРОЦЕСИ

### 3.1 СИНХРОНІЗАЦІЯ ЗАМОВЛЕНЬ

**Учасники:** Система, Horoshop API, Prom.ua API

**Тригери:**
- Автоматично кожні 15 хвилин (cron)
- Вручну через адмін-панель
- Webhook від магазину (реал-тайм)

**Процес:**
1. Система підключається до API магазину з збереженими credentials
2. Запитує нові замовлення (з моменту останньої синхронізації)
3. Для кожного замовлення:
   - Перевіряє чи існує (по ID магазину + зовнішній ID)
   - Якщо не існує - створює новий запис
   - Якщо існує і статус змінився - оновлює
4. Нормалізує дані з різних API в єдиний формат:
   - Horoshop: customer.name → customer_name
   - Prom.ua: client.name → customer_name
   - Horoshop: items[] → items[]
   - Prom.ua: products[] → items[]
5. Зберігає повні дані API в JSON полі для можливості перегляду
6. Встановлює статус "нове"
7. Логує кількість синхронізованих замовлень

**Результат:** Нові замовлення з'являються в адмін-панелі

**Обробка помилок:**
- При помилці API - логувати і повторити через 5 хвилин
- При помилці парсингу - логувати і пропустити замовлення
- При дублюванні - оновити існуючий запис

---

### 3.2 СТВОРЕННЯ РАХУНКУ

**Учасники:** Адміністратор, Система

**Початкові умови:** Є замовлення зі статусом "нове"

**Крок 1: Вибір компанії**
1. Адміністратор відкриває замовлення
2. Натискає "Створити рахунок"
3. Система показує форму:
   - Dropdown зі списком активних ФОП/ТОВ
4. Адміністратор вибирає компанію
5. Система автоматично:
   - Визначає чи з ПДВ (якщо компанія на ПДВ - встановлює прапорець)
   - Для єдиного податку розраховує і показує:
     * Ліміт на рік
     * Виписано за рік (сума всіх рахунків)
     * Залишок ліміту
   - Якщо залишок < 0 - показує попередження червоним кольором

**Крок 2: Тип ПДВ**
1. Система показує перемикач "З ПДВ / Без ПДВ"
2. Адміністратор може змінити (якщо компанія на ПДВ)
3. При зміні - всі суми перераховуються автоматично

**Крок 3: Реквізити покупця**
1. Система показує поле для пошуку по ІПН/ЄДРПОУ
2. Адміністратор вводить ІПН
3. Система шукає в базі контрагентів:
   - Якщо знайдено - автоматично заповнює всі поля (ПІБ, адреса, телефон)
   - Якщо не знайдено - показує порожні поля для ручного введення
4. Адміністратор заповнює/перевіряє:
   - Назва/ПІБ (обов'язково)
   - ЄДРПОУ/ІПН
   - Адреса
   - Телефон
   - Email
5. Система зберігає нового контрагента в базу для майбутнього використання

**Крок 4: Таблиця товарів**
1. Система автоматично підставляє товари із замовлення
2. Для кожного товару адміністратор може:
   - Змінити назву
   - Змінити кількість
   - Змінити ціну
   - Додати знижку (у % або у грн)
3. Система автоматично розраховує:
   - Сума по рядку = (кількість × ціна) - знижка
   - Загальна сума без ПДВ = сума всіх рядків
   - ПДВ 20% = загальна сума × 0.2 (якщо з ПДВ)
   - Загальна сума з ПДВ = сума без ПДВ + ПДВ
4. Адміністратор може додати нові товари або видалити зайві

**Крок 5: Коментар**
1. Адміністратор вводить коментар (опціонально)
2. Наприклад: "Рахунок до договору №5 від 01.01.2025"

**Крок 6: Підсумки та збереження**
1. Система показує підсумкову інформацію:
   - Сума без ПДВ
   - ПДВ 20% (якщо з ПДВ)
   - Всього до сплати (великим шрифтом)
2. Адміністратор натискає "Створити рахунок"
3. Система виконує:
   - Генерує номер рахунку (формат: INV-{ID_компанії}-{рік}-{номер})
   - Створює запис Рахунку
   - Створює записи Позицій рахунку
   - Оновлює статус замовлення на "виставлено рахунок"
   - Автоматично генерує Excel файл
   - Автоматично генерує PDF файл
   - Зберігає шляхи до файлів
4. Показує повідомлення "Рахунок створено" з кнопками завантаження

**Результат:** 
- Створено рахунок в БД
- Згенеровано Excel та PDF файли
- Замовлення має статус "виставлено рахунок"
- Адміністратор може завантажити документи

**Обробка помилок:**
- Якщо перевищено ліміт - попередження, але дозволити створити
- Якщо не заповнені обов'язкові поля - показати помилку
- Якщо помилка генерації файлів - створити рахунок, але показати попередження

---

### 3.3 ГЕНЕРАЦІЯ ДОКУМЕНТІВ

**Учасники:** Система

**3.3.1 Генерація Excel**

**Структура документа:**

**Шапка:**
- Логотип (якщо є)
- "Рахунок №INV-2025-00001"
- "від 15.01.2025"

**Блок постачальника:**
- Назва компанії
- ЄДРПОУ/ІПН
- Адреса
- Телефон
- Банківські реквізити (р/р, банк, МФО, IBAN)

**Блок покупця:**
- Назва/ПІБ
- ЄДРПОУ/ІПН
- Адреса
- Телефон

**Таблиця товарів:**
```
| № | Найменування | Кількість | Ціна | Знижка | Сума |
|---|--------------|-----------|------|--------|------|
| 1 | Товар 1      | 2 шт      | 500  | 0      | 1000 |
| 2 | Товар 2      | 1 шт      | 500  | 50     | 450  |
|---|--------------|-----------|------|--------|------|
|   | Разом:       |           |      |        | 1450 |
|   | ПДВ 20%:     |           |      |        | 290  |
|   | Всього:      |           |      |        | 1740 |
```

**Підсумок:**
- Всього до сплати: 1740.00 грн
- Прописом: Одна тисяча сімсот сорок гривень 00 копійок
- Коментар (якщо є)
- Підпис: _______________ (Посада ПІБ підписанта)
- М.П.

**Збереження:** storage/app/invoices/excel/{invoice_id}.xlsx

**3.3.2 Генерація PDF**

**Аналогічна структура як Excel**, але:
- Використовується HTML темплейт з Blade
- Шрифт DejaVu Sans (для підтримки кирилиці)
- Формат A4
- Збереження: storage/app/invoices/pdf/{invoice_id}.pdf

**Особливості:**
- Сума прописом генерується окремою функцією
- Формат: "Одна тисяча двісті тридцять чотири гривні 56 копійок"
- Підтримка як з ПДВ так і без ПДВ (різні шаблони)

---

### 3.4 РЕЄСТР ТРАНЗАКЦІЙ

**Учасники:** Адміністратор, Менеджер

**3.4.1 Дашборд компаній**

**Для кожної компанії відображається картка:**

**Якщо компанія на єдиному податку (ФОП):**
- Назва компанії
- Тип (ФОП)
- Ліміт на рік: 7,000,000 грн
- Виписано рахунків за рік: 4,500,000 грн
- Оплачено за рік: 4,200,000 грн
- Залишок ліміту: 2,500,000 грн
- Прогрес-бар з відсотком використання:
  * Зелений (0-70%)
  * Жовтий (70-90%)
  * Червоний (90-100%)

**Якщо компанія на ПДВ (ТОВ):**
- Назва компанії
- Тип (ТОВ)
- Виписано з ПДВ за рік: 1,200,000 грн
- Виписано без ПДВ за рік: 300,000 грн
- Оплачено з ПДВ: 1,100,000 грн
- Оплачено без ПДВ: 280,000 грн
- ПДВ до сплати: 200,000 грн

**Розрахунки:**
- Виписано = сума всіх рахунків за рік (незалежно від оплати)
- Оплачено = сума рахунків з прапорцем "оплачено"
- Залишок ліміту = ліміт - виписано (не оплачено!)
- ПДВ до сплати = сума всіх pdv_amount з рахунків з ПДВ

**3.4.2 Таблиця рахунків**

**Колонки:**
- Номер рахунку (можна шукати)
- Дата
- Наша компанія (dropdown фільтр)
- Контрагент-покупець (dropdown фільтр з пошуком)
- Сума
- З ПДВ / Без ПДВ (фільтр)
- Оплачено (галочка, можна змінювати прямо в таблиці)
- Дата оплати (видима якщо оплачено)
- Дії:
  * Переглянути
  * Завантажити Excel
  * Завантажити PDF

**Фільтри:**
1. По нашій компанії (вибір з dropdown)
2. По контрагенту (пошук з автодоповненням)
3. За період (дата від - дата до)
4. Оплачено / не оплачено
5. З ПДВ / без ПДВ

**Масові дії:**
- Вибрати декілька рахунків → експортувати в Excel
- Вибрати декілька рахунків → позначити оплаченими

**3.4.3 Відмітка про оплату**

**Процес:**
1. Адміністратор змінює прапорець "оплачено" в таблиці або натискає кнопку
2. Якщо встановлюється "оплачено":
   - Система автоматично встановлює дату оплати = сьогодні
   - Або адміністратор може вказати іншу дату
3. Якщо знімається "оплачено":
   - Система видаляє дату оплати
4. Система автоматично перераховує:
   - Виторг оплачених рахунків для компанії
   - Оновлює дашборд

**3.4.4 Експорт реєстру**

**Процес:**
1. Адміністратор застосовує фільтри (опціонально)
2. Натискає "Експортувати" або вибирає рахунки і "Експортувати вибране"
3. Система генерує Excel файл з колонками:
   - Номер рахунку
   - Дата
   - Наша компанія
   - Контрагент
   - Сума
   - З ПДВ
   - Оплачено
   - Дата оплати
4. Файл автоматично завантажується
5. Назва файлу: registry_{дата}_{час}.xlsx

---

### 3.5 УПРАВЛІННЯ ДОВІДНИКАМИ

**3.5.1 Магазини**

**CRUD операції (тільки адміністратор):**
- Створення:
  * Назва магазину
  * Тип (Horoshop / Prom.ua)
  * API credentials (JSON)
  * Активність
- Редагування всіх полів
- Видалення (якщо немає замовлень)
- Перегляд списку з фільтрами

**Додаткові функції:**
- Тест з'єднання (перевірка API credentials)
- Синхронізація замовлень вручну

**3.5.2 Наші компанії (ФОП/ТОВ)**

**CRUD операції (тільки адміністратор):**
- Створення:
  * Всі реквізити компанії
  * Валідація ЄДРПОУ/ІПН (10 цифр)
  * Річний ліміт (обов'язковий для єдиного податку)
- Редагування всіх полів
- Видалення (якщо немає рахунків)
- Архівування (встановлення is_active = false)

**Особливості:**
- При виборі "єдиний податок" - поле "річний ліміт" стає обов'язковим
- При виборі "ПДВ" - поле "річний ліміт" приховується

**3.5.3 Контрагенти**

**CRUD операції (тільки адміністратор):**
- Автостворення при створенні рахунку
- Ручне створення
- Редагування
- Видалення (якщо немає рахунків)

**Відмітка автостворення:**
- Якщо створено автоматично - показується іконка
- Дозволяє розрізняти "повних" контрагентів від автоматично створених

---

### 3.6 ПРАВА ДОСТУПУ

**Адміністратор:**
- Повний доступ до всіх модулів
- Створення/редагування/видалення магазинів
- Створення/редагування/видалення компаній
- Створення рахунків
- Зміна оплати рахунків
- Перегляд реєстру транзакцій
- Експорт даних

**Менеджер:**
- Тільки перегляд:
  * Замовлення (список і деталі)
  * Рахунки (список і деталі)
  * Реєстр транзакцій (дашборд і таблиця)
  * Завантаження згенерованих файлів
- Не може:
  * Створювати рахунки
  * Змінювати оплату
  * Редагувати довідники
  * Синхронізувати замовлення

---

## 4. АВТОМАТИЗАЦІЯ

### 4.1 Автоматична синхронізація
- Запускається кожні 15 хвилин через cron
- Синхронізує всі активні магазини
- Логує результати

### 4.2 Webhook обробка
- Миттєва синхронізація при новому замовленні
- Верифікація підпису для безпеки
- Обробка подій: order.created, order.updated

### 4.3 Автоматичне попередження про ліміти
- При досягненні 90% ліміту - показується попередження
- При перевищенні ліміту - попередження червоним

### 4.4 Автогенерація документів
- При створенні рахунку документи генеруються автоматично
- При помилці - рахунок створюється, але показується попередження
- Можна перегенерувати вручну

---

## 5. ІНТЕРФЕЙС КОРИСТУВАЧА

### 5.1 Головна сторінка (Dashboard)
**Widgets:**
- Кількість нових замовлень (без рахунків)
- Кількість рахунків за місяць + сума
- Кількість неоплачених рахунків + сума

### 5.2 Навігація
**Групи меню:**
- Налаштування:
  * Магазини
  * Наші компанії (ФОП/ТОВ)
  * Контрагенти
- Замовлення:
  * Список замовлень
- Документи:
  * Рахунки
  * Реєстр транзакцій

### 5.3 Список замовлень
- Таблиця з пагінацією
- Пошук по ID, ПІБ клієнта, телефону
- Фільтри: магазин, статус, дата
- Кнопка "Створити рахунок" (тільки для нових)
- Сортування по даті (нові зверху)

### 5.4 Список рахунків
- Таблиця з пагінацією
- Пошук по номеру, контрагенту
- Фільтри: компанія, дата, оплата, ПДВ
- Кнопки завантаження Excel/PDF
- Toggle для оплати прямо в таблиці

### 5.5 Форма створення рахунку
- Багатокрокова форма з автозаповненням
- Реактивні розрахунки (змінюється автоматично)
- Підказки та попередження
- Валідація обов'язкових полів

### 5.6 Реєстр транзакцій
- Дашборд з картками компаній зверху
- Таблиця рахунків знизу
- Фільтри справа
- Кнопка експорту зверху

---

## 6. НУМЕРАЦІЯ ТА ІДЕНТИФІКАЦІЯ

### 6.1 Номер рахунку
**Формат:** INV-{ID_компанії}-{рік}-{номер}  
**Приклад:** INV-3-2025-00001

**Правила:**
- Окрема нумерація для кожної компанії
- Скидається щороку (новий рік = номер 1)
- Автоінкремент в межах року
- Padded до 5 цифр (00001, 00002...)

### 6.2 Ідентифікатори в БД
- Всі ID автоінкрементні (bigint)
- UUID не використовуються

---

## 7. ВАЛІДАЦІЯ ДАНИХ

### 7.1 ЄДРПОУ/ІПН
- 10 цифр обов'язково
- Унікальність в межах таблиці

### 7.2 Телефони
- Формат: +380XXXXXXXXX
- Валідація через регулярний вираз

### 7.3 Email
- Стандартна email валідація Laravel

### 7.4 Суми
- Decimal (10,2) - дві цифри після коми
- Не може бути від'ємною

### 7.5 Дати
- Дата рахунку не може бути в майбутньому
- Дата оплати не може бути раніше дати рахунку

---

## 8. ОСОБЛИВІ ВИПАДКИ

### 8.1 Перевищення ліміту ФОП
**Ситуація:** При створенні рахунку сума перевищить ліміт

**Поведінка:**
- Показати попередження червоним
- Дозволити створити рахунок (не блокувати)
- На дашборді компанія буде червоного кольору

**Причина:** Іноді ліміт можна перевищити легально (наприклад, річний ліміт збільшився)

### 8.2 Замовлення без реквізитів покупця
**Ситуація:** В замовленні тільки ім'я і телефон, немає ІПН

**Поведінка:**
- Дозволити створити рахунок
- Реквізити заповнюються вручну
- Контрагент створюється без ІПН
- В майбутньому можна доповнити

### 8.3 Дублювання замовлень при синхронізації
**Ситуація:** Замовлення вже існує в БД

**Поведінка:**
- Перевірка по shop_id + external_id
- Якщо знайдено - оновити тільки статус (якщо змінився)
- Не створювати дублікатів

### 8.4 Помилка API при синхронізації
**Ситуація:** Магазин не відповідає або повертає помилку

**Поведінка:**
- Логувати помилку
- Продовжити синхронізацію інших магазинів
- Повторити через 15 хвилин (наступний cron)
- Показати помилку в адмін-панелі

### 8.5 Помилка генерації PDF
**Ситуація:** Не вдалося згенерувати PDF файл

**Поведінка:**
- Рахунок все одно створюється
- Показати попередження "PDF не згенеровано"
- Дозволити перегенерувати вручну пізніше

---

## 9. ФОРМАТ ДАНИХ API

### 9.1 Структура API credentials в таблиці shops

**Для Horoshop:**
```
{
  "api_key": "ключ доступу",
  "shop_id": "ID магазину",
  "webhook_secret": "секрет для верифікації webhook"
}
```

**Для Prom.ua:**
```
{
  "access_token": "токен доступу",
  "webhook_secret": "секрет для верифікації webhook"
}
```

### 9.2 Структура bank_details для компаній

```
{
  "bank_name": "ПриватБанк",
  "mfo": "305299",
  "account": "12345678901234567890",
  "iban": "UA123456789012345678901234567"
}
```

### 9.3 Структура raw_data для замовлень

Повна відповідь API зберігається як JSON без обробки.  
Використовується для:
- Дебагу
- Можливості переглянути всі дані
- Повторної обробки якщо змінилась логіка

---

## 10. ПРОДУКТИВНІСТЬ

### 10.1 Індекси БД
Створити індекси на:
- shops.type
- orders.shop_id, orders.external_id, orders.status
- our_companies.edrpou_ipn
- invoices.our_company_id, invoices.invoice_date, invoices.is_paid
- Унікальний індекс на: orders (shop_id + external_id)

### 10.2 Eager Loading
При завантаженні списків завжди підвантажувати relationships:
- Orders → Shop
- Invoices → OurCompany, Counterparty, Order
- Invoice → Items

### 10.3 Пагінація
Всі списки з пагінацією по 50 записів (можна змінити на 25/50/100)

---

## 11. БЕЗПЕКА

### 11.1 Аутентифікація
- Laravel стандартна аутентифікація
- Filament вбудована авторизація
- Паролі хешуються (bcrypt)

### 11.2 Авторизація
- Політики доступу (Policies) для кожної моделі
- Перевірка ролі перед кожною дією

### 11.3 Webhook безпека
- Верифікація HMAC підпису
- Відхилення запитів без валідного підпису
- Лог всіх спроб (успішних і невдалих)

### 11.4 API credentials
- Зберігаються в БД (не в коді)
- Шифруються на рівні Laravel (можна додати encrypt)
- Не показуються в інтерфейсі (masked)

### 11.5 Файли
- Зберігаються поза public директорією
- Доступ тільки через авторизований endpoint
- Немає прямих посилань на файли

---

## 12. ЛОКАЛІЗАЦІЯ

**Мова інтерфейсу:** Українська

**Формати:**
- Дати: дд.мм.рррр (15.01.2025)
- Час: 24-годинний формат
- Суми: пробіл як роздільник тисяч (1 000 000,00)
- Валюта: грн

**Сума прописом:**
- Повністю українською
- Формат: "Одна тисяча двісті тридцять чотири гривні 56 копійок"

---

## ПІДСУМОК

**Система вирішує:**
1. Автоматизація синхронізації замовлень з 4 магазинів
2. Швидке виставлення рахунків (2-3 хвилини на рахунок)
3. Автоматична генерація документів (Excel + PDF)
4. Контроль лімітів для ФОП на єдиному податку
5. Контроль ПДВ для ТОВ
6. Централізований облік всіх операцій
7. Економія часу: з 1-2 годин на день до 15-30 хвилин